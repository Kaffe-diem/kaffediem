---
title: Customizing the Menu
description: Learn how to manage the menu system in Kaffediem by working with categories, items, and customizations to create a flexible menu structure.
---

## Prerequisites

- Completed [Getting Started](/dev/tutorials/getting-started) and [Creating Your First Order](/dev/tutorials/creating-first-order)
- Understanding of the menu hierarchy
- Development environment running

## What You'll Learn

- How to create and manage categories
- How to add items to the menu
- How to set up customization keys and values
- How to link customizations to categories
- How the pricing system works with customizations

## Part 1: Understanding the Menu Hierarchy

The menu has a hierarchical structure:

```
Category (e.g., "Coffee")
│
├── has Items (e.g., "Latte", "Espresso")
│   └── each Item has a base price
│
└── defines valid_customizations (list of CustomizationKey IDs)
    │
    └── CustomizationKey (e.g., "Size")
        └── has CustomizationValues (e.g., "Small", "Medium", "Large")
            └── each Value has a price modifier
```

**Key insight**: Customizations are linked to **categories**, not individual items. This means all items in the "Coffee" category share the same customization options.

## Part 2: Create a New Category

### Via the Admin Interface

1. Navigate to http://localhost:5173/admin/menu
2. Click **"Add Category"** (or the equivalent button)
3. Fill in the form:
   - **Name**: "Smoothies"
   - **Sort Order**: 3 (determines display order)
   - **Enable**: ✓ (makes it visible)
4. Click **"Save"**

### What Happens Behind the Scenes

The frontend calls:

```typescript
import { createCategory } from "$lib/stores/menu";

await createCategory({
  id: "", // Generated by backend
  name: "Smoothies",
  sort_order: 3,
  enable: true,
  valid_customizations: [] // Empty for now
});
```

This sends `POST /api/collections/category/records` to the backend.

Backend flow:
1. `CategoryController.create/2` receives the request
2. `Kaffebase.Catalog.create/2` validates and inserts
3. `CollectionChannel.broadcast_change/3` broadcasts to all clients
4. Frontend `menu` store updates automatically

## Part 3: Add Items to the Category

### Create a New Item

1. In the menu admin, click **"Add Item"**
2. Fill in the form:
   - **Name**: "Mango Smoothie"
   - **Price (NOK)**: 65
   - **Category**: Select "Smoothies" (the category you just created)
   - **Image**: Upload an image (optional)
   - **Enable**: ✓
   - **Sort Order**: 1
3. Click **"Save"**

### Understanding Item Images

Images are handled specially:

```typescript
export function itemToApi(item: Item): FormData | Record<string, unknown> {
  if (item.imageFile) {
    const formData = new FormData();
    formData.append("name", item.name);
    formData.append("price_nok", item.price_nok.toString());
    formData.append("category", item.category);
    formData.append("image", item.imageFile);  // ← File upload
    return formData;
  }
  // Otherwise, send JSON
  return { name: item.name, price_nok: item.price_nok, ... };
}
```

The backend stores the image path in the `image` field.

## Part 4: Create Customization Keys

Now let's add customization options for smoothies.

### Create "Boost" Customization Key

1. In the menu admin, find the **Customization Keys** section
2. Click **"Add Customization Key"**
3. Fill in:
   - **Name**: "Boost"
   - **Multiple Choice**: ✓ (allow selecting multiple boosts)
   - **Default Value**: (leave empty for now)
   - **Label Color**: `#10b981` (a green color)
   - **Enable**: ✓
   - **Sort Order**: 1
4. Click **"Save"**

The `multiple_choice` field is important:
- `true`: Customer can select multiple values (e.g., "Protein + Vitamins")
- `false`: Customer can select only one value (e.g., "Small OR Medium OR Large")

## Part 5: Create Customization Values

### Add Values for the "Boost" Key

1. Click **"Add Customization Value"**
2. Fill in:
   - **Name**: "Protein"
   - **Belongs To**: Select "Boost" (the key you just created)
   - **Price Increment (NOK)**: 10
   - **Constant Price**: ✓ (additive, not multiplicative)
   - **Enable**: ✓
   - **Sort Order**: 1
3. Click **"Save"**

4. Repeat for more boosts:
   - **"Vitamins"**: +10 kr, constant
   - **"Energy"**: +15 kr, constant

### Understanding Price Modifiers

There are two types of price modifiers:

#### Additive (constant_price: true)

Adds a fixed amount to the price:

```typescript
finalPrice = basePrice + additive_sum
```

Example:
- Base: 65 kr
- Protein: +10 kr
- Vitamins: +10 kr
- **Total: 85 kr**

#### Multiplicative (constant_price: false)

Multiplies the price by a percentage:

```typescript
finalPrice = basePrice * multiplicative_product
```

The `price_increment_nok` value is stored as a whole number (e.g., 115 = 1.15×).

Example:
- Base: 65 kr
- "Extra Large" (stored as 150): ×1.50
- **Total: 97.5 kr → 98 kr** (rounded up)

The full pricing formula combines both:

```typescript
finalPrice = (basePrice + additive_sum) * multiplicative_product
```

File: `src/lib/pricing.ts`

```typescript
export const finalPrice = (basePrice: number, customizations: CustomizationValue[]): number => {
  const additive = sumBy(customizations, (c) =>
    c.constant_price ? c.price_increment_nok || 0 : 0
  );

  const multiplicative = productBy(customizations, (c) =>
    c.constant_price ? 1 : (c.price_increment_nok ?? 100) / 100
  );

  return Math.ceil((basePrice + additive) * multiplicative);
};
```

## Part 6: Link Customizations to Category

Now we need to tell the "Smoothies" category that it can use the "Boost" customization.

### Update the Category

1. Find the "Smoothies" category in the menu admin
2. Click **"Edit"**
3. In the **Valid Customizations** field:
   - Check "Boost" (and any other keys you want to allow)
4. Click **"Save"**

### Backend Representation

The `valid_customizations` field is stored as a JSON array:

```elixir
schema "category" do
  field :name, :string
  field :valid_customizations, :text  # Stored as JSON: ["boost_id", "size_id"]
end
```

When loading the menu, the backend includes only valid customizations for each item based on its category.

File: `kaffebase_web/channels/collection_channel.ex`

```elixir
defp load_collection("menu", _options) do
  # ...
  customizations =
    Enum.filter(keys, fn key -> key.id in valid_key_ids end)
    |> Enum.map(fn key ->
      %{
        key: key,
        values: Map.get(values_by_key, key.id, [])
      }
    end)
  # ...
end
```

## Part 7: Test Your New Menu Item

### Place an Order with Customizations

1. Go to http://localhost:5173/admin/orders/frontdesk
2. Select the "Smoothies" category
3. Click "Mango Smoothie"
4. Select customizations:
   - ✓ Protein (+10 kr)
   - ✓ Energy (+15 kr)
5. Observe the calculated price: **65 + 10 + 15 = 90 kr**
6. Add to cart and place the order

### Verify the Snapshot

After placing the order, check the database:

```bash
cd kaffebase
sqlite3 priv/repo/dev.db
```

```sql
SELECT json_pretty(items_data) FROM "order" ORDER BY inserted_at DESC LIMIT 1;
```

You'll see:

```json
[
  {
    "item_id": "smoothie_id",
    "name": "Mango Smoothie",
    "price": 65.0,
    "category": "smoothies_id",
    "customizations": [
      {
        "key_id": "boost_id",
        "key_name": "Boost",
        "value_id": "protein_id",
        "value_name": "Protein",
        "price_change": 10
      },
      {
        "key_id": "boost_id",
        "key_name": "Boost",
        "value_id": "energy_id",
        "value_name": "Energy",
        "price_change": 15
      }
    ]
  }
]
```

## Part 8: Advanced - Set a Default Customization

Let's say you want smoothies to default to "Medium" size.

### Create a "Size" Customization

1. Create a new CustomizationKey:
   - **Name**: "Size"
   - **Multiple Choice**: ☐ (only one size at a time)
   - **Enable**: ✓
2. Create CustomizationValues:
   - **"Small"**: -5 kr (constant)
   - **"Medium"**: 0 kr (constant)
   - **"Large"**: +5 kr (constant)

### Set the Default

1. Edit the "Size" CustomizationKey
2. Set **Default Value**: Select "Medium"
3. Save

Now, when a customer selects a smoothie, "Medium" is automatically selected.

Frontend logic: `src/lib/stores/cart.ts`

```typescript
export const applyDefaults = () => {
  const { customization_keys: keys, customization_values: values } = get(indexes);
  const selected = get(selectedCustomizations);

  for (const key of keys) {
    const current = selected[key.id] ?? [];
    const defaultValue = values.find((val) => val.id === key.default_value);

    if (current.length === 0 && key.default_value && defaultValue?.enable) {
      selected[key.id] = [defaultValue];  // ← Auto-select default
    }
  }
  // ...
};
```

### Link to Category

Don't forget to add "Size" to the Smoothies category's `valid_customizations`!

## Part 9: Disable an Item Temporarily

Sometimes you run out of ingredients and need to temporarily hide an item.

### Disable the Item

1. Find "Mango Smoothie" in the menu admin
2. Click **"Edit"**
3. Uncheck **"Enable"**
4. Save

The item immediately disappears from the frontdesk and customer-facing menus.

### Why Not Delete?

Disabling preserves:
- Historical orders (they still reference the item)
- Configuration (customizations, images, pricing)
- Order history analytics

You can re-enable it later without recreating everything.

## Part 10: Real-time Menu Updates

### Watch Live Updates

1. Open http://localhost:5173/admin/orders/frontdesk in one browser tab
2. Open http://localhost:5173/admin/menu in another tab
3. Edit a menu item's name or price
4. **Watch the frontdesk update in real-time** without refreshing!

### How It Works

File: `src/lib/stores/menu.ts`

```typescript
export const menu = createChannelStore<MenuPayload>("menu", {
  initialValue: emptyMenu,
  extract: (response: unknown) => toMenuPayload(response?.items),
  onChange: (event, { set }) => {
    const changeEvent = event as { action?: string; record?: unknown };

    // Backend sends the ENTIRE menu on any update
    if (changeEvent?.action === "update" && changeEvent?.record) {
      set(toMenuPayload(changeEvent.record));  // ← Replace entire menu
    }
  }
});
```

Unlike individual records (like orders), the menu is **always sent as a whole** to simplify synchronization.

## Part 11: Understanding Sort Order

The `sort_order` field controls display order:

- **Lower numbers** appear first
- If two items have the same `sort_order`, they're sorted alphabetically
- You can use any integers (0, 1, 2... or 10, 20, 30... for easy reordering)

Example:

```
Categories:
├── sort_order: 1 → "Coffee"
├── sort_order: 2 → "Tea"
├── sort_order: 3 → "Smoothies"
└── sort_order: 4 → "Pastries"
```

## Key Takeaways

You now understand:

- ✅ How to create categories, items, and customizations
- ✅ How customizations link to categories (not items)
- ✅ The difference between additive and multiplicative pricing
- ✅ How default values work
- ✅ Why disabling is better than deleting
- ✅ How real-time menu updates work

## Next Steps

- **[Pricing System](/dev/concepts/pricing-system)** - Deep dive into calculations
- **[Domain Model](/dev/concepts/domain-model)** - Understand all entities
- **[Add New Customization Type](/dev/how-to/add-new-customization-type)** - Extend the system

## Exercises

1. **Create a "Pastries" category** with items like "Croissant" and "Muffin"
2. **Add a "Gluten-Free" customization** (additive +10 kr)
3. **Set up a "Temperature" customization** for coffee (Hot/Iced, multiplicative)
4. **Test complex pricing**: Item with both additive and multiplicative customizations
5. **Experiment with sort orders**: Rearrange menu items

## Common Patterns

### Sizing with Multiplicative Pricing

```
Size Key (multiple_choice: false)
├── Small: 80 (×0.80)
├── Medium: 100 (×1.00)
└── Large: 120 (×1.20)
```

### Extras with Additive Pricing

```
Extras Key (multiple_choice: true)
├── Extra Shot: +10 kr
├── Whipped Cream: +5 kr
└── Caramel Drizzle: +8 kr
```

### Mutually Exclusive Options

```
Milk Type Key (multiple_choice: false)
├── Regular: 0 kr
├── Oat: +5 kr
├── Almond: +5 kr
└── Soy: +5 kr
```

## Troubleshooting

### Customization Not Showing Up

Check:
1. Customization Key is enabled
2. Customization Values are enabled
3. Values have `belongs_to` set to the correct Key ID
4. Category's `valid_customizations` includes the Key ID

### Price Not Calculating Correctly

Check:
1. `constant_price` is set correctly (true = additive, false = multiplicative)
2. For multiplicative, value should be like 150 (not 1.50)
3. Base price is set on the item

### Real-time Updates Not Working

Check:
1. Backend is running
2. WebSocket connection is active (check browser console)
3. No CORS errors in console
